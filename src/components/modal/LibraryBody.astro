---
import SearchIcon from '@/components/icons/SearchIcon.astro';
import SwitchPlainIcon from '@/components/icons/SwitchPlainIcon.astro';
import SwitchMarkdownIcon from '@/components/icons/SwitchMarkdownIcon.astro';
import ZipIcon from '@/components/icons/ZipIcon.astro';
---

<div class="library-body">
  <div class="library-header">
    <div class="new-notes-grid">
      <button
        id="new-markdown-btn"
        class="modal-btn modal-confirm share-full-btn markdown-btn-styled"
      >
        <SwitchMarkdownIcon size={18} />
        New Markdown
      </button>
      <button id="new-plain-btn" class="modal-btn modal-confirm share-full-btn">
        <SwitchPlainIcon size={18} />
        New Plain Text
      </button>
    </div>
    <div style="margin-top: 12px;">
      <button
        id="bulk-export-btn"
        class="modal-btn modal-cancel share-full-btn"
        style="border-radius: 9999px;"
      >
        <ZipIcon size={18} />
        Export All (ZIP)
      </button>
    </div>
    <div class="library-search-section">
      <div class="search-input-wrapper">
        <SearchIcon size={16} class="search-icon" />
        <input
          type="text"
          id="library-search"
          class="modal-input"
          placeholder="Search notes or content..."
        />
      </div>
      <div id="tag-filter-container" class="tag-filter-container">
        <!-- Tags will be injected here -->
      </div>
    </div>
    <div class="library-tabs">
      <button class="lib-tab active" data-mode="markdown">Markdown</button>
      <button class="lib-tab" data-mode="plain">Plain Text</button>
    </div>
  </div>

  <div class="library-section">
    <label>Your Collection</label>
    <div id="notebook-list" class="notebook-list">
      <!-- Notebook items will be injected here by script -->
      <div class="loading-state">Loading your collection...</div>
    </div>
  </div>
</div>

<style is:global>
  .library-body {
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding: 10px 0;
  }

  .library-header {
    margin-bottom: 10px;
  }

  .new-notes-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  @media (max-width: 480px) {
    .new-notes-grid {
      grid-template-columns: 1fr;
    }
  }

  .markdown-btn-styled {
    background-color: #2196f3 !important;
  }

  .library-section {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .library-section label {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-color);
    opacity: 0.8;
  }

  .notebook-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 400px;
    overflow-y: auto;
    padding: 5px;
  }

  .library-search-section {
    margin-top: 15px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .search-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }

  .search-icon {
    position: absolute;
    left: 12px;
    transform: translateY(-50%);
    opacity: 0.4;
    pointer-events: none;
  }

  #library-search {
    padding-left: 38px;
    width: 100%;
    box-sizing: border-box;
  }

  .tag-filter-container {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding-bottom: 5px;
    -webkit-overflow-scrolling: touch;
  }

  .tag-filter-container::-webkit-scrollbar {
    height: 4px;
  }

  .tag-item {
    padding: 4px 10px;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    border: 1px solid transparent;
  }

  .tag-item:hover {
    background: rgba(0, 0, 0, 0.1);
  }

  .tag-item.active {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
  }

  .notebook-tags {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    margin-top: 4px;
  }

  .mini-tag {
    font-size: 0.65rem;
    padding: 2px 6px;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 4px;
    opacity: 0.8;
  }

  .pin-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ffd700;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    z-index: 20;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .action-btn.pin.active {
    color: #fbc02d;
    border-color: rgba(251, 192, 45, 0.4);
    background: rgba(251, 192, 45, 0.05);
  }

  .library-tabs {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding-bottom: 2px;
  }

  body[data-theme='dark'] .library-tabs {
    border-color: rgba(255, 255, 255, 0.1);
  }

  .lib-tab {
    padding: 8px 16px;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--text-color);
    opacity: 0.6;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.2s;
  }

  .lib-tab:hover {
    opacity: 1;
  }

  .lib-tab.active {
    opacity: 1;
    border-bottom-color: #3b82f6;
    color: #3b82f6;
  }

  body[data-theme='dark'] .tag-item,
  body[data-theme='dark'] .mini-tag {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.8);
  }

  body[data-theme='dark'] .tag-item:hover {
    background: rgba(255, 255, 255, 0.15);
  }

  body[data-theme='dark'] .tag-item.active {
    background: #3b82f6;
    color: white;
  }

  /* Custom scrollbar for notebook-list */
  .notebook-list::-webkit-scrollbar {
    width: 6px;
  }

  .notebook-list::-webkit-scrollbar-track {
    background: transparent;
  }

  .notebook-list::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 3px;
  }

  body[data-theme='dark'] .notebook-list::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1);
  }

  .notebook-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: rgba(0, 0, 0, 0.03);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid transparent;
  }

  .notebook-item:hover {
    background: rgba(0, 0, 0, 0.06);
    /* transform: translateY(-1px); */
  }

  .notebook-item.active {
    background: rgba(59, 130, 246, 0.08);
    border-color: rgba(59, 130, 246, 0.3);
  }

  .notebook-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 60px; /* Increased to fit the 3D effect */
    height: 60px;
    flex-shrink: 0;
    perspective: 400px;
    margin-right: 10px;
  }

  /* Mini Moleskine Design */
  .moleskine-notebook {
    height: 50px;
    width: 35px;
    position: relative;
    transition: 0.4s ease-in-out;
    border-radius: 2px 4px 4px 2px;
    transform-origin: left center 0px;
    display: inline-block;
    perspective: 400px;
  }

  .notebook-item:hover .moleskine-notebook {
    /* transform: rotateZ(-5deg); */
  }

  .notebook-item:hover .notebook-cover {
    /* transform: rotateY(-45deg); */
    z-index: 999;
    box-shadow: 5px 2px 10px rgba(0, 0, 0, 0.2);
  }

  .notebook-cover {
    height: 50px;
    width: 35px;
    position: absolute;
    border-radius: 2px 5px 5px 2px;
    z-index: 10;
    transition: 0.4s ease;
    transform-style: preserve-3d;
    transform-origin: left center 0px;
    background: #cc4b48; /* Default Red for Plain */
  }

  .notebook-cover:before {
    content: '';
    position: absolute;
    width: 3px;
    height: calc(100% + 1px);
    top: -0.5px;
    z-index: 100;
    border-radius: 1px;
    right: 5px;
    transition: 2s ease;
  }

  /* Red (Plain) */
  .notebook-cover.red {
    background: #cc4b48;
  }
  .notebook-cover.red:before {
    background: linear-gradient(
      to right,
      #9c2e2b 0%,
      #cc4b48 12%,
      #9c2e2b 25%,
      #cc4b48 37%,
      #9c2e2b 50%,
      #cc4b48 62%,
      #9c2e2b 75%,
      #cc4b48 87%,
      #9c2e2b 100%
    );
  }

  /* Blue (Markdown) */
  .notebook-cover.blue {
    background: #2e95aa;
  }
  .notebook-cover.blue:before {
    background: linear-gradient(
      to right,
      #1e606e 0%,
      #2e95aa 12%,
      #1e606e 25%,
      #2e95aa 37%,
      #1e606e 50%,
      #2e95aa 62%,
      #1e606e 75%,
      #2e95aa 87%,
      #1e606e 100%
    );
  }

  .notebook-skin {
    height: 12px;
    background: #e8e8e0;
    margin-top: 20px;
    padding: 0 4px;
    font-size: 5px;
    position: relative;
    z-index: 10;
    color: #222;
    text-align: left;
    box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    font-weight: bold;
  }

  .notebook-skin:after {
    content: 'NOTE';
  }

  .notebook-skin:before {
    content: '';
    position: absolute;
    width: 100%;
    height: 3px;
    left: 0;
    bottom: 0;
    background: #cddc39;
  }

  .notebook-page {
    height: 100%;
    width: 35px;
    position: absolute;
    background-color: #fbfae8;
    z-index: 0;
    border-radius: 2px 6px 6px 2px;
    overflow: hidden;
  }

  .notebook-page.ruled {
    background: linear-gradient(to bottom, #fbfae8 2px, #e4e4e4 1px);
    background-size: 100% 3px;
  }

  .notebook-info {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
  }

  .notebook-title {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--text-color);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .notebook-meta {
    font-size: 0.75rem;
    color: var(--text-color);
    opacity: 0.6;
    display: flex;
    gap: 8px;
    margin-top: 2px;
  }

  .notebook-actions {
    display: flex;
    gap: 8px;
    opacity: 0;
    transition: opacity 0.2s;
    margin-top: 8px;
  }

  .notebook-item:hover .notebook-actions {
    opacity: 1;
  }

  @media (max-width: 768px) {
    .notebook-actions {
      opacity: 1;
    }
  }

  .action-btn {
    padding: 6px 12px;
    border-radius: 6px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    background: white;
    cursor: pointer;
    color: var(--text-color);
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-size: 0.8rem;
    font-weight: 500;
  }

  .action-btn.edit {
    border-color: rgba(59, 130, 246, 0.3);
    color: #3b82f6;
  }

  .action-btn.edit:hover {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
  }

  .action-btn.delete {
    border-color: rgba(244, 67, 54, 0.3);
    color: #f44336;
  }

  .action-btn.delete:hover {
    background: #f44336;
    color: white;
    border-color: #f44336;
  }

  body[data-theme='dark'] .action-btn {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
  }

  body[data-theme='dark'] .action-btn.edit {
    border-color: rgba(59, 130, 246, 0.4);
  }

  body[data-theme='dark'] .action-btn.delete {
    border-color: rgba(244, 67, 54, 0.4);
  }

  .loading-state {
    padding: 40px;
    text-align: center;
    color: var(--text-color);
    opacity: 0.5;
    font-style: italic;
  }

  .share-full-btn {
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    padding: 12px;
  }
</style>
